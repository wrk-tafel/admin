<div class="row ms-1">
  <div testid="errorMessage" *ngIf="errorMessage" class="alert alert-danger mb-3">
    <div testid="errorMessageContent">{{errorMessage}}</div>
  </div>
</div>
<div class="d-flex flex-column-reverse flex-lg-column">
  <div class="d-flex flex-column flex-lg-row mt-3 mt-lg-0 mb-4 mb-lg-0">
    <c-dropdown>
      <button testid="printMenuButton" cButton cDropdownToggle color="primary" class="text-white">
        Daten ausdrucken
      </button>
      <ul cDropdownMenu>
        <li><a cDropdownItem style="cursor: pointer;" testid="printCombinedButton" (click)="printCombined()">Stammdaten + Ausweis</a></li>
        <li><hr cDropdownDivider></li>
        <li><a cDropdownItem style="cursor: pointer;" testid="printMasterdataButton" (click)="printMasterdata()">Nur Stammdaten</a></li>
        <li><a cDropdownItem style="cursor: pointer;" testid="printIdCardButton" (click)="printIdCard()">Nur Ausweis</a></li>
      </ul>
    </c-dropdown>
    <c-dropdown class="mt-3 mt-lg-0 ms-lg-3">
      <button testid="prolongButton" cButton cDropdownToggle color="primary" class="text-white">
        Bezug verlängern
      </button>
      <ul cDropdownMenu>
        <li><a cDropdownItem style="cursor: pointer;" testid="prolongOneMonthButton" (click)="prolongCustomer(1)">1 Monat</a></li>
        <li><a cDropdownItem style="cursor: pointer;" testid="prolongTwoMonthsButton" (click)="prolongCustomer(2)">2 Monate</a></li>
        <li><a cDropdownItem style="cursor: pointer;" testid="prolongThreeMonthsButton" (click)="prolongCustomer(3)">3 Monate</a></li>
        <li><a cDropdownItem style="cursor: pointer;" testid="prolongSixMonthsButton" (click)="prolongCustomer(6)">6 Monate</a></li>
        <li><a cDropdownItem style="cursor: pointer;" testid="prolongTwelveMonthsButton" (click)="prolongCustomer(12)">12 Monate</a></li>
      </ul>
    </c-dropdown>
    <button cButton color="danger" class="mt-3 mt-lg-0 ms-lg-3 text-white" testid="invalidateCustomerButton" (click)="invalidateCustomer()"
            [disabled]="!customerData">Kunde deaktivieren
    </button>
    <button cButton color="danger" class="mt-3 mt-lg-0 ms-lg-3 text-white" testid="editCustomerButton" (click)="editCustomer()"
            [disabled]="!customerData">Kunde bearbeiten
    </button>
    <button cButton color="danger" class="mt-3 mt-lg-0 ms-lg-3 text-white" testid="deleteCustomerButton" (click)="showDeleteCustomerModal = true"
            [disabled]="!customerData">Kunde löschen
    </button>
  </div>
  <div class="row mt-0 mt-lg-3 mb-0 mb-lg-3">
    <div class="col">
      <c-nav variant="tabs">
        <c-nav-item>
          <a [cTabContent]="tabContent1" [routerLink] [tabPaneIdx]="0" cNavLink>
            Allgemeine Daten
          </a>
        </c-nav-item>
        <c-nav-item>
          <a [cTabContent]="tabContent1" [routerLink] [tabPaneIdx]="1" cNavLink>
            <i class="fa fa-users"></i> Weitere Personen ({{customerData?.additionalPersons.length}})
          </a>
        </c-nav-item>
      </c-nav>
      <c-tab-content #tabContent1="cTabContent" [activeTabPaneIdx]="0" cRounded="bottom">
        <c-tab-pane class="p-3 preview" role="tabpanel">
          <div class="row">
            <div class="col-lg-6 col-sm-12">
              <div class="card">
                <div class="card-header text-center h5">Hauptbezieher</div>
                <div class="card-body">
                  <div class="row">
                    <div class="col fw-bold">Kundennummer</div>
                    <div testid="customerIdText" class="col">{{customerData?.id}}</div>
                  </div>
                  <div class="row">
                    <div class="col fw-bold">Name</div>
                    <div testid="nameText" class="col">{{customerData?.lastname}} {{customerData?.firstname}}</div>
                  </div>
                  <div class="row">
                    <div class="col fw-bold">Geburtsdatum (Alter)</div>
                    <div testid="birthDateAgeText" class="col">{{customerData?.birthDate | date : 'dd.MM.yyyy'}} ({{getAge(customerData?.birthDate)}})</div>
                  </div>
                  <div class="row">
                    <div class="col fw-bold">Nationalität</div>
                    <div testid="countryText" class="col">{{customerData?.country?.name}}</div>
                  </div>
                  <div class="row">
                    <div class="col fw-bold">Telefon</div>
                    <div testid="telephoneNumberText" class="col"
                         [innerHTML]="customerData?.telephoneNumber ? customerData?.telephoneNumber : '-'"></div>
                  </div>
                  <div class="row">
                    <div class="col fw-bold">E-Mail</div>
                    <div testid="emailText" class="col" [innerHTML]="customerData?.email ? customerData?.email : '-'">
                    </div>
                  </div>
                  <hr>
                  <div class="row">
                    <div class="col fw-bold">Adresse</div>
                    <div class="col">
                      <div class="row">
                        <div testid="addressLine1Text" class="col">{{customerData?.address ?
                          formatAddressLine1(customerData?.address) : ''}}</div>
                      </div>
                      <div class="row">
                        <div testid="addressLine2Text" class="col"
                             [innerHTML]="customerData?.address ? formatAddressLine2(customerData?.address) : ''">
                        </div>
                      </div>
                    </div>
                  </div>
                  <hr>
                  <div class="row">
                    <div class="col fw-bold">Arbeitgeber</div>
                    <div testid="employerText" class="col">{{customerData?.employer}}</div>
                  </div>
                  <div class="row mt-2 align-items-end">
                    <div class="col fw-bold">
                      Einkommen (monatlich)
                    </div>
                    <div testid="incomeText" class="col">{{customerData?.income | currency}}</div>
                  </div>
                  <div class="row align-items-end">
                    <div class="col">
                      nachgewiesen bis:
                    </div>
                    <div testid="incomeDueText" class="col">{{customerData?.incomeDue | date : 'dd.MM.yyyy'}}</div>
                  </div>
                  <hr>
                  <div class="row">
                    <div class="col fw-bold">Angelegt</div>
                    <div testid="issuedInformation" class="col">am {{customerData?.issuedAt | date : 'dd.MM.yyyy'}}
                      von {{formatIssuer(customerData?.issuer)}}</div>
                  </div>
                  <div class="row">
                    <div class="col fw-bold text-white"
                         [ngClass]="{'bg-success': customerData?.validUntil && isValid(), 'bg-danger': customerData?.validUntil && !isValid()}">
                      Gültig bis:
                    </div>
                    <div testid="validUntilText"
                         class="col text-white"
                         [ngClass]="{'bg-success': customerData?.validUntil && isValid(), 'bg-danger': customerData?.validUntil && !isValid()}"
                         [innerHTML]="customerData?.validUntil | date : 'dd.MM.yyyy'"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-6 col-sm-12 mt-4 mt-sm-0">
              <c-card>
                <c-card-header>
                  <c-row>
                    <c-col>
                      <h5>Aktuellste Notiz</h5>
                    </c-col>
                    <c-col class="text-end">
                      <button testid="addnote-button" cButton color="success" (click)="showAddNewNoteModal = true">
                        <i class="fa fa-plus text-white"></i>
                      </button>
                    </c-col>
                  </c-row>
                </c-card-header>
                <c-card-body>
                  <c-row>
                    <c-col class="fw-bold" *ngIf="customerNotes?.length === 0">
                      <h6 testid="nonotes-label">Keine Notiz vorhanden</h6>
                    </c-col>
                    <c-col *ngIf="customerNotes?.length !== 0">
                      <c-row class="mb-2">
                        <c-col class="fw-bold" testid="note-title">
                          {{customerNotes[0].timestamp | date : 'dd.MM.yyyy HH:mm' }}&nbsp;{{customerNotes[0].author}}
                        </c-col>
                      </c-row>
                      <c-row>
                        <c-col testid="note-text" [innerHtml]="customerNotes[0].note"></c-col>
                      </c-row>
                    </c-col>
                  </c-row>
                </c-card-body>
                <c-card-footer *ngIf="customerNotes.length > 1">
                  <button testid="showall-notes-button" cButton color="primary" class="text-white" (click)="showAllNotesModal = true">Alle Notizen anzeigen</button>
                </c-card-footer>
              </c-card>
            </div>
          </div>
        </c-tab-pane>
        <c-tab-pane class="p-3 preview" role="tabpanel">
          <div class="row" *ngIf="customerData?.additionalPersons.length === 0">
            <div class="col mt-3">
              <h6 testid="nopersons-label">Keine Personen vorhanden</h6>
            </div>
          </div>
          <div *ngIf="customerData?.additionalPersons.length > 0">
            <div class="row mt-4">
              <ng-container *ngFor="let addPerson of customerData?.additionalPersons; let i = index">
                <div class="col-12 col-lg-6">
                  <div class="card">
                    <div class="card-body">
                      <div class="row">
                        <div class="col fw-bold" [attr.testid]="'addperson-' + i + '-lastnameText'"
                             [innerHTML]="addPerson?.lastname"></div>
                        <div class="col fw-bold" [attr.testid]="'addperson-' + i + '-firstnameText'"
                             [innerHTML]="addPerson?.firstname"></div>
                      </div>
                      <div class="row">
                        <div class="col-6" [attr.testid]="'addperson-' + i + '-birthDateAgeText'">{{customerData?.birthDate | date : 'dd.MM.YYYY'}} ({{getAge(customerData?.birthDate)}})</div>
                        <div class="col-6" [attr.testid]="'addperson-' + i + '-countryText'">{{addPerson?.country.name}}</div>
                      </div>
                      <div class="row mt-1">
                        <div class="col-6 fw-bold">Arbeitgeber</div>
                        <div class="col-6" [attr.testid]="'addperson-' + i + '-employerText'" *ngIf="addPerson?.employer !== null">{{addPerson?.employer}}</div>
                        <div class="col-6" [attr.testid]="'addperson-' + i + '-employerText'" *ngIf="addPerson?.employer === null">-</div>
                      </div>
                      <div class="row mt-1 align-items-end">
                        <div class="col-6 fw-bold">Einkommen (monatl.)</div>
                        <div class="col-6" [attr.testid]="'addperson-' + i + '-incomeText'" *ngIf="addPerson?.income">{{addPerson?.income | currency}}</div>
                        <div class="col-6" [attr.testid]="'addperson-' + i + '-incomeText'" *ngIf="!addPerson?.income">-</div>
                      </div>
                      <div class="row align-items-end">
                        <div class="col-6">nachgewiesen bis:</div>
                        <div class="col-6 align-bottom" [attr.testid]="'addperson-' + i + '-incomeDueText'" *ngIf="addPerson?.incomeDue">{{addPerson?.incomeDue | date : 'dd.MM.yyyy'}}</div>
                        <div class="col-6 align-bottom" [attr.testid]="'addperson-' + i + '-incomeDueText'" *ngIf="!addPerson?.incomeDue">-</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div *ngIf="i % 2 != 0" class="w-100"></div>
              </ng-container>
            </div>
          </div>
        </c-tab-pane>
      </c-tab-content>
    </div>
  </div>
</div>
<c-modal id="deleteCustomerModal" testid="deletecustomer-modal" [(visible)]="showDeleteCustomerModal">
  <c-modal-header>
    <h4 class="modal-title">Kunde löschen</h4>
    <button type="button" class="close" (click)="showDeleteCustomerModal = false" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </c-modal-header>
  <c-modal-body>
    <div class="row mb-3">
      <div class="col">Der Kunde wird unwiderruflich gelöscht.</div>
    </div>
    <div class="row mb-3">
      <div class="col fw-bold">Sicher?</div>
    </div>
  </c-modal-body>
  <c-modal-footer>
    <button testid="okButton" type="button" class="btn btn-primary" (click)="deleteCustomer()">Löschen
    </button>
    <button testid="cancelButton" type="button" class="btn btn-secondary" (click)="showDeleteCustomerModal = false">
      Abbrechen
    </button>
  </c-modal-footer>
</c-modal>
<c-modal id="showAllNotesModal" testid="showallnotes-modal" [(visible)]="showAllNotesModal">
  <c-modal-header>
    <h4 class="modal-title">Alle Notizen</h4>
    <button type="button" class="close" (click)="showAllNotesModal = false" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </c-modal-header>
  <c-modal-body>
    <div class="row" *ngFor="let noteItem of customerNotes; let i = index">
      <div class="col" *ngIf="customerNotes?.length !== 0">
        <hr *ngIf="i > 0">
        <div class="row mb-2">
          <div class="col fw-bold" testid="note-title">{{noteItem.timestamp | date : 'dd.MM.yyyy HH:mm' }}&nbsp;{{noteItem.author}}</div>
        </div>
        <div class="row">
          <div class="col" testid="note-text" [innerHtml]="noteItem.note"></div>
        </div>
      </div>
    </div>
  </c-modal-body>
  <c-modal-footer>
    <button testid="cancelButton" type="button" class="btn btn-primary" (click)="showAllNotesModal = false">
      OK
    </button>
  </c-modal-footer>
</c-modal>
<c-modal id="addNewNoteModal" testid="addnew-note-modal" [(visible)]="showAddNewNoteModal">
  <c-modal-header>
    <h4 class="modal-title">Neue Notiz hinzufügen</h4>
    <button type="button" class="close" (click)="newNoteText = undefined; showAddNewNoteModal = false;"
            aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </c-modal-header>
  <c-modal-body>
    <textarea id="textarea-input" name="textarea-input" rows="9" class="form-control"
              [(ngModel)]="newNoteText"></textarea>
  </c-modal-body>
  <c-modal-footer>
    <button testid="okButton" type="button" class="btn btn-primary" (click)="addNewNote()"
            [disabled]="!newNoteText || newNoteText.trim().length == 0">Speichern
    </button>
    <button testid="cancelButton" type="button" class="btn btn-secondary"
            (click)="newNoteText = undefined; showAddNewNoteModal = false;">
      Abbrechen
    </button>
  </c-modal-footer>
</c-modal>
