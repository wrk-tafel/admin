<div testid="errorMessage" *ngIf="errorMessage" class="alert alert-danger mb-3">
  <div testid="errorMessageContent">{{errorMessage}}</div>
</div>
<c-row>
  <c-col>
    <c-card>
      <c-card-body>
        <c-row>
          <c-col class="mb-2">
            <h4>Kunden-Annahme</h4>
          </c-col>
        </c-row>
        <c-row>
          <c-col sm="3" class="align-self-center">
            <label class="form-label">Scanner</label>
          </c-col>
          <c-col sm="3" class="align-self-center">
            <select testid="scannerIdInput" class="form-control" cSelect [(ngModel)]="selectedScannerId" tabindex="0">
              <option [ngValue]="undefined">Nicht aktiv</option>
              <option *ngFor="let scannerId of scannerIds" [ngValue]="scannerId">Nr. {{scannerId}}</option>
            </select>
          </c-col>
          <c-col>
            <h5>
              <c-badge [color]="scannerReadyStateColor" testid="state-server" class="mt-3 mt-md-0 mt-lg-0">
                {{scannerReadyState ? 'AKTIV' : 'INAKTIV'}}
              </c-badge>
            </h5>
          </c-col>
        </c-row>
        <hr>
        <c-row>
          <c-col sm="3">
            <label class="form-label">Kundennummer</label>
          </c-col>
          <c-col sm="3" class="mb-3">
            <input testid="customerIdText" type="number" name="customerIdInput" [(ngModel)]="customerId"
                   class="form-control" (keydown.enter)="searchForCustomerId()" tabindex="1"
                   cdkTrapFocusAutoCapture="focusCustomerIdInput" cdkTrapFocus="focusCustomerIdInput">
          </c-col>
          <c-col sm="3">
            <button testid="showCustomerButton" type="button" class="btn btn-primary text-white"
                    tabindex="2" [disabled]="!customerId" (click)="searchForCustomerId()">Anzeigen
            </button>
          </c-col>
        </c-row>
      </c-card-body>
    </c-card>
    <c-card class="mt-3" *ngIf="customer !== undefined" testid="customerDetailPanel">
      <c-card-body>
        <c-row>
          <c-col class="mb-2">
            <h4>
              <c-badge [color]="customerStateColor">
                {{customerStateText}}
              </c-badge>
              {{customer.id}} - {{customer.lastname}} {{customer.firstname}}
            </h4>
          </c-col>
        </c-row>
        <c-row>
          <c-col>Gültig bis:</c-col>
          <c-col>{{customer.validUntil | date : 'dd.MM.yyyy'}}</c-col>
        </c-row>
        <hr>
        <c-row>
          <c-col>Adresse:</c-col>
          <c-col>{{formatAddress()}}</c-col>
        </c-row>
        <c-row>
          <c-col>Personen im Haushalt (insgesamt):</c-col>
          <c-col>{{customer.additionalPersons.length + 1}}</c-col>
        </c-row>
        <c-row>
          <c-col>Personen unter 3 Jahren:</c-col>
          <c-col>{{getInfantCount()}}</c-col>
        </c-row>
        <hr>
        <c-row>
          <c-col>
            <c-card>
              <c-card-header class="fw-bold">Aktuellste Notiz</c-card-header>
              <c-card-body>
                <div class="fw-bold" *ngIf="customerNotes?.length === 0">
                  <h6 testid="nonotes-label">Keine Notiz vorhanden</h6>
                </div>
                <div *ngIf="customerNotes && customerNotes?.length !== 0">
                  <div class="row mb-2">
                    <div class="col fw-bold" testid="note-title">{{customerNotes[0].timestamp | date : 'dd.MM.yyyy HH:mm' }}&nbsp;{{customerNotes[0].author}}</div>
                  </div>
                  <div class="row">
                    <div class="col" testid="note-text" [innerHtml]="customerNotes[0].note"></div>
                  </div>
                </div>
              </c-card-body>
            </c-card>
          </c-col>
        </c-row>
        <c-row>
          <c-col>
            <form #ticketForm="ngForm">
              <div *ngIf="customerState !== 0">
                <hr>
                <c-row>
                  <c-col sm="12" md="2" class="fw-bold">Ticket-Nummer: *</c-col>
                  <c-col sm="12" md="2" class="align-middle">
                    <input testid="ticketNumberText" type="number" name="ticketNumberText" [(ngModel)]="ticketNumber"
                           class="form-control" required (keydown.enter)="assignCustomer()" tabindex="3"
                           [cdkTrapFocusAutoCapture]="focusTicketNumberInput" [cdkTrapFocus]="focusTicketNumberInput">
                  </c-col>
                </c-row>
              </div>
            </form>
          </c-col>
        </c-row>
      </c-card-body>
      <c-card-footer>
        <c-row>
          <c-col>
            <button [disabled]="customerState === 0 || !ticketForm.valid" testid="assignCustomerButton" class="btn btn-success me-3 text-white" (click)="assignCustomer()" tabindex="4">Annehmen</button>
          </c-col>
          <c-col>
            <button testid="resetButton" class="btn btn-primary text-white" (click)="reset()" [cdkTrapFocusAutoCapture]="focusResetButton" [cdkTrapFocus]="focusResetButton" tabindex="5">Zurücksetzen</button>
          </c-col>
        </c-row>
      </c-card-footer>
    </c-card>
  </c-col>
</c-row>
